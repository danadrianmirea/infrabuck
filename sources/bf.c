/*   windows/x86 brainfuck compiler
 *   written by mitxela
 *   http://mitxela.com/projects/infrabuck
 */

#include <time.h>
#include <stdio.h>
#include <stdlib.h>

// Header prototype
// MSDOS Stub
// PE Header
// .data Reserve 32768 bytes for tape
// .idata Import:
//   kernel32: ExitProcess
//   msvcrt: putchar, getchar
const unsigned char exeHead[]={
0x4D,0x5A,0x80,0x00,0x01,0x00,0x00,0x00,0x04,0x00,0x10,0x00,0xFF,0xFF,0x00,0x00,
0x40,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,
0x0E,0x1F,0xBA,0x0E,0x00,0xB4,0x09,0xCD,0x21,0xB8,0x01,0x4C,0xCD,0x21,0x54,0x68,
0x69,0x73,0x20,0x70,0x72,0x6F,0x67,0x72,0x61,0x6D,0x20,0x63,0x61,0x6E,0x6E,0x6F,
0x74,0x20,0x62,0x65,0x20,0x72,0x75,0x6E,0x20,0x69,0x6E,0x20,0x44,0x4F,0x53,0x20,
0x6D,0x6F,0x64,0x65,0x2E,0x0D,0x0A,0x24,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x50,0x45,0x00,0x00,0x4C,0x01,0x03,0x00,0x44,0xC8,0x05,0x59,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0xE0,0x00,0x0F,0x01,0x0B,0x01,0x01,0x47,0x00,0x02,0x00,0x00,
0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xA0,0x00,0x00,0x00,0xA0,0x00,0x00,
0x00,0x10,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x10,0x00,0x00,0x00,0x02,0x00,0x00,
0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x0A,0x00,0x00,0x00,0x00,0x00,
0x00,0xB0,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,
0x00,0x10,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x90,0x00,0x00,0xA4,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2E,0x64,0x61,0x74,0x61,0x00,0x00,0x00,
0x00,0x80,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xC0,0x00,0x00,0xC0,
0x2E,0x69,0x64,0x61,0x74,0x61,0x00,0x00,0xA4,0x00,0x00,0x00,0x00,0x90,0x00,0x00,
0x00,0x02,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x40,0x2E,0x74,0x65,0x78,0x74,0x00,0x00,0x00,
0x29,0x00,0x00,0x00,0x00,0xA0,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x04,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x60,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x58,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x3C,0x90,0x00,0x00,
0x60,0x90,0x00,0x00,0x78,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x4A,0x90,0x00,0x00,0x84,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x6B,0x65,0x72,0x6E,
0x65,0x6C,0x33,0x32,0x2E,0x64,0x6C,0x6C,0x00,0x00,0x6D,0x73,0x76,0x63,0x72,0x74,
0x2E,0x64,0x6C,0x6C,0x00,0x00,0x00,0x00,0x68,0x90,0x00,0x00,0x00,0x00,0x00,0x00,
0x68,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x45,0x78,0x69,0x74,0x50,0x72,
0x6F,0x63,0x65,0x73,0x73,0x00,0x00,0x00,0x90,0x90,0x00,0x00,0x9A,0x90,0x00,0x00,
0x00,0x00,0x00,0x00,0x90,0x90,0x00,0x00,0x9A,0x90,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x70,0x75,0x74,0x63,0x68,0x61,0x72,0x00,0x00,0x00,0x67,0x65,0x74,0x63,
0x68,0x61,0x72,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x55,0x89,0xE5,0xBB,0x00,0x10,0x40,0x00
};
const unsigned char tail[]= { 0x89,0xEC,0x5D,0xFF,0x15,0x60,0x90,0x40 };

const unsigned char _putchar[] = { 0x53,0x8B,0x03,0x50,0xFF,0x15,0x84,0x90,0x40,0x00,0x83,0xC4,0x04,0x5B };
const unsigned char _getchar[] = { 0x53,0xFF,0x15,0x88,0x90,0x40,0x00,0x5B,0x88,0x03 };
unsigned char _inc[]  = { 0x80,0x03,0x01 };
unsigned char _dec[]  = { 0x80,0x2B,0x01 };
unsigned char _next[] = { 0x83,0xC3,0x01 };
unsigned char _prev[] = { 0x83,0xEB,0x01 };
unsigned char _nextLong[] = { 0x81,0xC3,0x01,0x00,0x00,0x00 };
unsigned char _prevLong[] = { 0x81,0xEB,0x01,0x00,0x00,0x00 };

unsigned char _open[]      = { 0x8B,0x03,0x3C,0x00,0x74,0x0A };
unsigned char _openLong[]  = { 0x8B,0x03,0x3C,0x00,0x0F,0x84,0x80,0x00,0x00,0x00 };
unsigned char _close[]     = { 0x8B,0x03,0x3C,0x00,0x75,0xFA };
unsigned char _closeLong[] = { 0x8B,0x03,0x3C,0x00,0x0F,0x85,0x7B,0xFF,0xFF,0xFF };


FILE *in;
FILE *out;
int *stack;

int error(char* msg) {
  printf(msg);
  fclose(in);
  fclose(out);
  free(stack);
  return 1;
};

// Condense runs of sequential ops
int run(char m){
  int num=1;
  char j;
  do {
    while (m==(j=fgetc(in))) num++;
  } while (j!='['&&j!=']'&&j!='+'&&j!='-'&&j!='.'&&j!=','&&j!='>'&&j!='<'&&j!=EOF);
  if (j!=EOF) fseek(in, -1, SEEK_CUR);
  return num;
}

int main(int argc, char *argv[]) {
  int depth=0;
  int i;

  if ( argc != 3 ){
    printf("\nx86 Brainfuck Compiler by mitxela\nhttp://mitxela.com/\n\nUsage: bf infile outfile\n\n");
    return 1;
  }

  if ((in = fopen(argv[1],"r"))==NULL) {
    printf("Unable to open file '%s'",argv[1]);
    return 1;
  }

  if ((out = fopen(argv[2],"wb+"))==NULL) {
    printf("Unable to open file '%s' (still running?)",argv[2]);
    return 1;
  }

  fwrite(exeHead,sizeof(unsigned char),sizeof(exeHead),out);

  // Preprocess: count the number of loops for mem allocation
  while ((i=fgetc(in)) !=EOF){
    if (i=='[') depth++;
  }
  stack = malloc(depth * sizeof(int));
  depth = 0;

  rewind(in);

  // Main pass

  #define op(d) fwrite(d, sizeof(unsigned char), sizeof(d), out)

  while ((i=fgetc(in)) !=EOF){
    switch (i) {
      case '.':
        op(_putchar);
      break;
      case ',':
        op(_getchar);
      break;
      case '+':
        _inc[2] = (unsigned char)run(i);
        op(_inc);
      break;
      case '-':
        _dec[2] = (unsigned char)run(i);
        op(_dec);
      break;
      case '>':
      {
        int j = run(i);
        if (j>127) {
          fwrite(_nextLong, sizeof(unsigned char), sizeof(_nextLong)-4, out);
          fwrite(&j,4,1,out);
        } else {
          _next[2]=(unsigned char)j;
          op(_next);
        }
      }
      break;
      case '<':
      {
        int j = run(i);
        if (j>127) {
          fwrite(_prevLong, sizeof(unsigned char), sizeof(_prevLong)-4, out);
          fwrite(&j,4,1,out);
        } else {
          _prev[2]=(unsigned char)j;
          op(_prev);
        }
      }
      break;
      case '[':
        op(_openLong);
        stack[depth++] = ftell(out);
      break;
      case ']':
      {
        if (depth == 0) return error("Syntax error: ] before [\n");

        int dist = ftell(out) - stack[--depth];

        if ( sizeof(_close)+dist < 128) {
          _close[5] = -sizeof(_close)-dist;
          op(_close);
          dist += sizeof(_close);
        } else {
          fwrite(_closeLong, sizeof(unsigned char), sizeof(_closeLong)-4, out);
          int l = -dist-sizeof(_closeLong);
          fwrite(&l, 4, 1, out);
          dist += sizeof(_closeLong);
        }
        fseek(out, -4 -dist, SEEK_CUR);
        fwrite(&dist, sizeof(int),1,out);
        fseek(out, dist, SEEK_CUR);
      }
      break;
    }
  }

  if (depth != 0) return error("Syntax error: missing ]\n");
  free(stack);
  op(tail);


  int codeSize = ftell(out)-0x400;
  int rawSize = (1+(codeSize / 0x200)) * 0x200;
  int imageSize = ((rawSize-0x200 ) /0x1000 ) *0x1000 + 0xB000 ;

  fseek(out,rawSize+0x3FF,SEEK_SET);
  fputc(0,out);

  // 0x88 Timestamp
  fseek(out,0x88,SEEK_SET);
  int t = (int)time(NULL);
  fwrite(&t,sizeof(int),1,out);


  // 0x1D0 .text VirtualSize (appears to be code size +1)
  codeSize++;
  fseek(out,0x1D0,SEEK_SET);
  fwrite(&codeSize, sizeof(int),1,out);
  codeSize--;

  // 0x1D8 Size of Raw Data
  fseek(out,0x1D8,SEEK_SET);
  fwrite(&rawSize, sizeof(int),1,out);

  //0x9C PE Size of Code (= size of raw data)
  fseek(out,0x9C,SEEK_SET);
  fwrite(&rawSize, sizeof(int),1,out);

  //d0 size of image
  fseek(out,0xD0,SEEK_SET);
  fwrite(&imageSize, sizeof(int),1,out);


  fclose(in);
  fclose(out);

  return 0;
}
